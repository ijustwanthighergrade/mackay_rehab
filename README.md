# ğŸ¥ å¾©å¥åµæ¸¬ç³»çµ±æ•´åˆèªªæ˜æ›¸

æœ¬èªªæ˜æ–‡ä»¶æä¾› **Pose Landmarker Android å°ˆæ¡ˆ** çš„æŠ€è¡“ç¸½è¦½ã€ç”¨é€”ã€æ¨¡çµ„èªªæ˜èˆ‡æ•´åˆæ–¹å¼ï¼Œå”åŠ©å¾ŒçºŒé–‹ç™¼è€…å¿«é€Ÿä¸Šæ‰‹åŠæ•´åˆé€²ä¸»ç³»çµ±ã€‚

---

## ğŸ“˜ å°ˆæ¡ˆæ¦‚è¿°

æœ¬å°ˆæ¡ˆç‚ºå¾©å¥ç”¨çš„å§¿å‹¢åµæ¸¬èˆ‡å‹•ä½œè©•ä¼°æ‡‰ç”¨ï¼ŒåŸºæ–¼ **MediaPipe Pose Landmarker** æŠ€è¡“ï¼Œé–‹ç™¼æ–¼ Android å¹³å°ï¼Œå”åŠ©å¾©å¥æ‚£è€…å³æ™‚ç›£æ¸¬èˆ‡åˆ†æå‹•ä½œè¡¨ç¾ã€‚  

### ğŸ¯ é–‹ç™¼ç›®æ¨™
- **å‹•ä½œè¾¨è­˜èˆ‡ç²¾æº–åµæ¸¬**ï¼šåˆ¤æ–·ä½¿ç”¨è€…æ˜¯å¦æ­£ç¢ºåŸ·è¡Œæ·±è¹²ã€æè¸µã€å¾©å¥æè¸µç­‰å‹•ä½œã€‚  
- **å³æ™‚è¦–è¦ºå›é¥‹**ï¼šé€ééª¨æ¶åœ–èˆ‡ HUD æä¾›å³æ™‚é‹å‹•åˆ†æã€‚  
- **å®¢è£½åŒ–å¾©å¥è¦å‰‡**ï¼šä»¥è§’åº¦èˆ‡æŒçºŒæ™‚é–“ç­‰åƒæ•¸åˆ¤å®šæˆæœã€‚  
- **çµæœè¨˜éŒ„èˆ‡åŒ¯å‡º**ï¼šå„²å­˜è¨“ç·´æ­·ç¨‹ï¼ˆJSON/CSVï¼‰ã€‚

### ğŸ’¡ è¨­è¨ˆç†å¿µ
æ¡ç”¨ **æ¨¡çµ„åŒ–æ¶æ§‹ (Modular Architecture)**ï¼š
- `rehabcore.domain` â€” åµæ¸¬é‚è¼¯ã€‚
- `rehabcore.mediapipe` â€” æ¨¡å‹æ¨è«–æ§åˆ¶ã€‚
- `rehabcore.overlay` â€” ç•«é¢ç¹ªè£½ã€‚
- `app.ui` â€” ä½¿ç”¨è€…äº’å‹•ã€‚

å„ªé»ï¼š
- æ˜“æ–¼ç¶­è­·èˆ‡æ“´å……ã€‚
- å„å±¤å¯ç¨ç«‹æ¸¬è©¦èˆ‡é‡ç”¨ã€‚
- æ¨¡å‹ã€åƒæ•¸ã€UI å¯æ¨¡çµ„åŒ–æ•´åˆã€‚

---

## âš™ï¸ åŠŸèƒ½ç‰¹è‰²

1. **å¤šå‹•ä½œæ”¯æ´**  
   - æ·±è¹² (Squat)  
   - æè¸µ (Calf Raise)  
   - å¾©å¥æè¸µ (Rehab Calf)

2. **å³æ™‚å§¿å‹¢åˆ†æ**  
   [`PoseLandmarkerClient`](mediapipe-samples/examples/pose_landmarker/android/app/src/main/java/rehabcore/mediapipe/PoseLandmarkerClient.kt:23) ä½¿ç”¨ Live Stream è™•ç†é¡é ­å¹€ï¼Œä¾ landmarks æ›´æ–°é¡¯ç¤ºã€‚

3. **HUD èˆ‡éª¨æ¶ç¹ªè£½**  
   [`SkeletonOverlay`](mediapipe-samples/examples/pose_landmarker/android/app/src/main/java/rehabcore/overlay/SkeletonOverlay.kt:11) è² è²¬è¦–è¦ºå‘ˆç¾ã€‚

4. **è¨“ç·´çµæœç´€éŒ„**  
   [`SessionResultWriter`](mediapipe-samples/examples/pose_landmarker/android/app/src/main/java/app/data/SessionResultWriter.kt) è¼¸å‡º JSON/CSV çµ±è¨ˆã€‚

---

## ğŸ§  å‹•ä½œæª¢æ¸¬é‚è¼¯è©³ç´°åˆ†æ

### 1ï¸âƒ£ æ·±è¹²ï¼ˆSquatDetectorï¼‰

#### åµæ¸¬æ–¹æ³•
ä½¿ç”¨å·¦å³è†é—œç¯€ä¸‰é»è§’åº¦ï¼ˆ`hip-knee-ankle`ï¼‰é€²è¡Œå‹•ä½œè¾¨è­˜ï¼Œé¸å–å¯è¦‹åº¦é«˜è€…ä½œç‚ºä¸»è¦å´ã€‚
```kotlin
val (rawAngle, side) = kneeAngleWithSide(landmarks)
```
é€é **æŒ‡æ•¸å¹³æ»‘ (EMA)**ï¼š
```kotlin
emaAngle = Î± * rawAngle + (1 - Î±) * emaAngle_prev
```
ä»¥ç§»é™¤ç¬é–“æŠ–å‹•ã€‚

#### ç‹€æ…‹è®ŠåŒ–
| ç‹€æ…‹ | è½‰æ›æ¢ä»¶ | èªªæ˜ |
|------|-----------|------|
| STAND â†’ DOWN | è§’åº¦ â‰¤ standUpDeg - 5Â° | é–‹å§‹ä¸‹è¹² |
| DOWN â†’ STAND | è§’åº¦ â‰¥ standUpDeg | å®Œæˆä¸€æ¬¡å›åˆ |

#### æˆåŠŸæ¢ä»¶
åº•éƒ¨è§’åº¦ï¼ˆminAngleThisRepï¼‰åœ¨ç¯„åœï¼š
- `succMinDeg ~ succMaxDeg` â†’ è¨ˆç‚ºæˆåŠŸ  
- `failMinDeg ~ failMaxDeg` â†’ è¨ˆç‚ºå¤±æ•—ï¼ˆä¸å¤ æ·±ï¼‰  
- å…¶ä»– â†’ ç„¡æ•ˆæ·±åº¦ã€‚

çµæœè¨˜éŒ„ï¼š
```kotlin
RepLog(outcome = "SUCCESS", minAngleThisRep = value)
```

#### HUD è³‡è¨Š
- è§’åº¦ï¼ˆç•¶å‰è†è§’ï¼‰
- ç‹€æ…‹ï¼ˆSTAND / DOWNï¼‰
- æˆåŠŸã€å¤±æ•—æ¬¡æ•¸
- æ´»å‹•è…¿å´ï¼ˆL/Rï¼‰
- å¹³å‡ FPS

#### ğŸ‹ï¸ æ·±è¹² (SquatParams) â€” åƒæ•¸èˆ‡ç”¨é€”è©³è§£

é€™çµ„åƒæ•¸æ§åˆ¶è†é—œç¯€è§’åº¦çš„è®ŠåŒ–åˆ¤æ–·é‚è¼¯ï¼Œæ±ºå®šå‹•ä½œéšæ®µè¾¨è­˜èˆ‡æˆåŠŸè¨ˆæ•¸è¦å‰‡ã€‚

| åƒæ•¸åç¨± | é è¨­å€¼ | èªªæ˜ |
|------------|----------|-----------|
| **standUpDeg** | `170f` | åˆ¤å®šã€Œç«™ç«‹å®Œæˆã€çš„è†é—œç¯€è§’åº¦ï¼Œè§’åº¦é«˜æ–¼æ­¤è¦–ç‚ºç›´ç«‹ã€‚ |
| **succMinDeg** | `95f` | æˆåŠŸä¸‹è¹²ç¯„åœçš„æœ€å°è§’åº¦ï¼ˆè¶Šä½è¡¨ç¤ºä¸‹è¹²è¶Šæ·±ï¼‰ã€‚ |
| **succMaxDeg** | `135f` | æˆåŠŸä¸‹è¹²ç¯„åœçš„æœ€å¤§è§’åº¦ï¼Œè¶…éæ­¤ä»£è¡¨å‹•ä½œå¤ªæ·ºã€‚ |
| **failMinDeg** | `136f` | å¤±æ•—å‹•ä½œåˆ¤å®šä¸‹é™è§’åº¦ï¼šæ­¤è§’åº¦ä»¥ä¸Šè¦–ç‚ºæ²’ä¸‹è¹²å¤ æ·±ã€‚ |
| **failMaxDeg** | `162f` | å¤±æ•—å‹•ä½œåˆ¤å®šä¸Šé™è§’åº¦ã€‚è‹¥è†è§’æœªé€¼è¿‘ç«™ç«‹è§’å°±å›å½ˆæœƒè¢«ç®—å¤±æ•—ã€‚ |
| **emaAlpha** | `0.35f` | è§’åº¦å¹³æ»‘åƒæ•¸ï¼ˆæŒ‡æ•¸ç§»å‹•å¹³å‡ï¼‰ï¼šè¶Šå¤§åæ‡‰è¶Šå¿«é€Ÿä½†é›œè¨Šè¶Šå¤šã€‚ |
| **smoothN** | `5` | é¡å¤–å¹³æ»‘æ­¥æ•¸ï¼ˆå¤šå¹€å¹³å‡ï¼‰ï¼Œé™ä½ç¬é–“è§’åº¦æ³¢å‹•èª¤å·®ã€‚ |

##### å‹•ä½œé‚è¼¯
- ç•¶è†è§’ä¸‹é™è‡³ `standUpDeg - 5Â°` ä»¥ä¸‹ â†’ é€²å…¥ã€Œä¸‹è¹²éšæ®µã€(DOWN)ã€‚  
- ç•¶è†è§’å†æ¬¡ä¸Šå‡è¶…é `standUpDeg` â†’ å›åˆ°ã€Œç«™ç«‹éšæ®µã€(STAND)ï¼Œè¨˜éŒ„ä¸€å›åˆçµæœã€‚  
- åˆ¤æ–·ä½¿ç”¨å›åˆä¸­é”åˆ°çš„æœ€å°è§’åº¦ (`minAngleThisRep`) æ±ºå®šæˆåŠŸ/å¤±æ•—ã€‚

##### æˆåŠŸå€é–“èˆ‡å¤±æ•—æ¢ä»¶
- æˆåŠŸè§’åº¦ï¼š`succMinDeg â‰¤ minAngle â‰¤ succMaxDeg` â†’ **SUCCESS**
- å¤±æ•—è§’åº¦ 1ï¼š`failMinDeg â‰¤ minAngle â‰¤ failMaxDeg` â†’ **FAIL_RANGE**
- å¤±æ•—è§’åº¦ 2ï¼šå…¶ä»–è§’åº¦å€é–“ â†’ **FAIL_INVALID_DEPTH**ï¼ˆå¤ªæ·±æˆ–æ ¹æœ¬æ²’ä¸‹å»ï¼‰

> ğŸ“ˆ ä¸‹è¹²æ¼”ç®—æ³•ä»¥é›™è…³è†é—œç¯€ä¸­å¯è¦‹åº¦æœ€é«˜çš„ä¸€å´ç‚ºä¸»ï¼›è§’åº¦ç”± hipã€kneeã€ankle ä¸‰é»å‘é‡è¨ˆç®—ï¼Œå–®å›åˆçµæŸæ™‚çš„ `RepLog` æœƒè¨˜éŒ„æœ€å°è§’ã€æ™‚é–“æˆ³èˆ‡çµæœã€‚

---

### 2ï¸âƒ£ æè¸µé‹å‹•ï¼ˆCalfDetectorï¼‰

#### åµæ¸¬æ ¸å¿ƒ
ä»¥è…³è·Ÿèˆ‡è…³å°–è·é›¢ï¼ˆ`heel-to-toe baseline`ï¼‰ç‚ºåŸºæº–ï¼Œåµæ¸¬è…³è·Ÿé«˜åº¦è®ŠåŒ–ã€‚

**å‚è·å…¬å¼**ï¼š
```kotlin
heelLift = |APx * ABy - APy * ABx| / âˆš(ABxÂ² + AByÂ²)
```
å°‡ heel ç›¸å°æ–¼ toe-heel åŸºç·šçš„è®ŠåŒ–è§’åº¦è½‰æ›æˆåº¦æ•¸ï¼ˆÎ¸ï¼‰ã€‚  

**å¹³æ»‘åŒ–**èˆ‡ **Î”è§’é‹ç®—**ï¼š
```kotlin
deltaDeg = max(0f, absAngle - repBaseDeg)
```

#### ç‹€æ…‹æµç¨‹
| ç‹€æ…‹ | é€²å…¥æ¢ä»¶ | å‹•ä½œèªªæ˜ |
|-------|------------|----------|
| CALIB | æº–å‚™â†’åŸºæº–ç·šæ ¡æ­£ | åµæ¸¬è…³å®‰å®šèˆ‡è¶³é•· |
| IDLE | éœæ­¢ç‹€æ…‹ | ç­‰å¾…ä¸‹ä¸€æ¬¡æè¸µ |
| RAISING | æŠ¬è…³å•Ÿå‹•å¾Œ | Î”è§’ä¸Šå‡ä¸­ |
| HOLDING | æŠ¬è…³ç¶­æŒ | æŒçºŒåˆ¤æ–· holdSeconds æ˜¯å¦é”æ¨™ |
| COOLDOWN | çµæŸå›åˆå†·å»æœŸ | æº–å‚™ä¸‹æ¬¡å‹•ä½œ |

#### æˆåŠŸèˆ‡å¤±æ•—åˆ¤æ–·
- æˆåŠŸï¼š`holdSeconds` å…§æŒçºŒæŠ¬è…³è‡³ `aMin~aMax` é–“  
- å¤±æ•—ï¼š
  - æè¸µä¸è¶³ï¼š`deltaDeg < aMin`
  - æŠ¬å¤ªé«˜ä¸ç©©ï¼š`deltaDeg > aMax + tol`
  - æ‹–åœ°ï¼ˆè…³å°–é›¢åœ°ï¼‰è¶…é™ï¼š`TOE_OFF_GROUND`

##### ç‰¹æ®Šé˜²èª¤ï¼š
- **ç¡¬æ€§å†·å»ï¼ˆCOOLDOWN â‰¥ 1sï¼‰**  
- **å¿«é€Ÿå†æ ¡æº–ï¼ˆFast Recalibï¼‰**  
- **é›™é‡é˜²æŠ– (holdLowFrames + holdDropGraceSec)**  

#### è¨˜éŒ„è³‡è¨Š
- æ¯å›åˆè¨˜éŒ„åŒ…æ‹¬ï¼š
  - èµ·å§‹è§’ (`baseDeg`)
  - å³°å€¼ Î”è§’ (`peakDeg`)
  - æŒçºŒç§’æ•¸ (`holdSec`)
  - çµæœ (`SUCCESS` / `FAIL_*`)
- å„²å­˜åœ¨ `RepLog` ä¸­ï¼Œæ–¼å®Œæˆå¾Œè¼¸å‡º JSONã€‚

---
#### ğŸ¦¶ æè¸µ (CalfParams) â€” åƒæ•¸èˆ‡ç”¨é€”è©³è§£

é€™å¥—åƒæ•¸æ§åˆ¶ã€Œæè¸µã€å‹•ä½œçš„å…¨æµç¨‹è‡ªå‹•åˆ¤å®šï¼Œå¾åˆæ¬¡æ ¡æ­£ã€èµ·èˆ‰ã€ç¶­æŒã€å†·å»èˆ‡é‡æ–°æ ¡æ­£çš†é©ç”¨ã€‚

| åƒæ•¸åç¨± | é è¨­å€¼ | åŠŸèƒ½èªªæ˜ |
|------------|----------|-----------|
| **aMin** | `7.5f` | æŠ¬è…³æˆåŠŸçª—å£è§’åº¦ä¸‹é™ï¼ˆÎ”è§’å¤§æ–¼æ­¤è¦–ç‚ºé–‹å§‹æŠ¬è…³ï¼‰ã€‚ |
| **aMax** | `60f` | æŠ¬è…³æˆåŠŸçª—å£è§’åº¦ä¸Šé™ï¼Œéé«˜ä»£è¡¨ä¸ç©©å®šæˆ–èª¤åˆ¤å‹•ä½œã€‚ |
| **idleThreshold** | `6f` | è¦–ç‚ºã€Œè…³å·²æ”¾ä¸‹ã€çš„è§’åº¦é–€æª»ã€‚ä½æ–¼æ­¤æœƒé€²å…¥ IDLE ç‹€æ…‹ã€‚ |
| **holdSeconds** | `3f` | æŠ¬è…³å¾Œéœ€ç¶­æŒåœ¨æˆåŠŸçª—å£å…§çš„ç§’æ•¸ã€‚ |
| **emaAlpha** | `0.35f` | å‡å€¼å¹³æ»‘ä¿‚æ•¸ï¼Œå½±éŸ¿è§’åº¦åæ‡‰é€Ÿåº¦ï¼ˆè¶Šå¤§è¶Šå³æ™‚ï¼‰ã€‚ |
| **angleNoiseMax** | `60f` | çµ•å°è§’ä¸Šé™é‰—åˆ¶å€¼ï¼šé¿å…åœ–åƒå°–å³°é€ æˆéŒ¯èª¤è§’åº¦ã€‚ |

---

##### ğŸŸ¢ èµ·è·³èˆ‡å‰ç½®ä¼‘æ¯
| åƒæ•¸ | é è¨­å€¼ | èªªæ˜ |
|------|---------|------|
| **raiseEnterDeg** | `3f` | å…è¨±èµ·è·³çš„æœ€ä½çµ•å°è§’ã€‚ |
| **restNeedSec** | `0.15f` | é€²å…¥ RAISING å‰å¿…é ˆåœ¨ä½è§’åº¦éœæ­¢è‡³å°‘æ­¤ç§’æ•¸ã€‚ |

æ­¤æ©Ÿåˆ¶æ¨¡æ“¬äººé«”ã€Œæ”¾é¬†â†’èµ·èˆ‰ã€çš„è‡ªç„¶ç¯€å¥ï¼Œé¿å…å‹•ä½œéŠœæ¥éå¿«èª¤åˆ¤ã€‚

---

##### âš™ï¸ åˆæ¬¡åŸºç·šæ ¡æ­£ (CALIB)
| åƒæ•¸ | é è¨­å€¼ | åŠŸèƒ½ |
|------|---------|------|
| **standStillFrames** | `8` | éœ€é€£çºŒç©©å®šå¹€æ•¸ä»¥ç¢ºèªä½¿ç”¨è€…ç«™ç©©ã€‚ |
| **standStillSpeedPx** | `8f` | toe/heel ç§»å‹•é€Ÿåº¦ä¸Šé™ (åƒç´ /ç§’)ã€‚ |
| **standStillSlopeMaxDeg** | `20f` | è¶³éƒ¨å‚¾æ–œå¡åº¦ä¸Šé™ã€‚ |
| **standStillAngleMax** | `6f` | è¶³éƒ¨ä»°è§’ä¸Šé™ã€‚ |
| **maxCalibWaitMs** | `2500L` | æ ¡æ­£æœ€é•·ç­‰å¾…æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰ã€‚ |
| **minFootLenPx** | `40f` | è¶³é•·æœ€å°åƒç´ è·é›¢ã€‚ |
| **minFootLenRatio** | `0.08f` | è¶³é•·ä½”æ•´å€‹ç•«é¢çš„æœ€å°æ¯”ä¾‹ã€‚ |

æ­¤å€åƒæ•¸ç¢ºä¿åœ¨ç«™ç©©æ™‚åˆå§‹åŒ– baseToe/baseHeel ä½œç‚ºåŸºæº–ç·šã€‚

---

##### ğŸ§­ IDLE ç‹€æ…‹è‡ªå‹•é‡æ–°æ ¡æ­£
| åƒæ•¸ | é è¨­å€¼ | æ„ç¾© / ç”¨é€” |
|------|---------|-------------|
| **softDriftPx** | `15f` | å¾®é‡é£„ç§»ï¼ˆtoe/heel ä½ç§»ï¼‰è§¸ç™¼ã€Œè»Ÿæ ¡æ­£ã€ã€‚ |
| **softLenDriftRatio** | `0.25f` | è¶³é•·è®ŠåŒ–å…è¨±æ¯”ç‡ä¸Šé™ã€‚ |
| **softSlopeMaxDeg** | `25f` | åµæ¸¬åˆ°å‚¾æ–œéåº¦å³å•Ÿå‹•é‡æ–°åŸºç·šæ‹‰å›ã€‚ |
| **hardDriftPx** | `40f` | ç¡¬æ€§é‡æ–°æ ¡æ­£è§¸ç™¼ï¼ˆæ˜é¡¯ä½ç§»ï¼‰ã€‚ |
| **hardLenDriftRatio** | `0.50f` | è¶³é•·è®ŠåŒ–éå¤§ä¹‹ç•Œç·šã€‚ |
| **hardSlopeMaxDeg** | `45f` | å‚¾æ–œéåº¦è§¸ç™¼ç›´æ¥å› Calib ç‹€æ…‹ã€‚ |
| **recalibFastFrames** | `4` | å¿«é€Ÿæ ¡æ­£æ¨¡å¼éœ€ç©©å®šå½±æ ¼æ•¸ã€‚ |
| **recalibFastTimeoutMs** | `1200L` | å¿«é€Ÿé‡æ ¡æ­£è¶…æ™‚æ™‚é–“ã€‚ |
| **recalibCooldownAfterIdleMs** | `1200L` | æ¯æ¬¡æ ¡æ­£å¾Œå†·å»æ™‚é–“ï¼Œé˜²æ­¢é »ç¹é‡ç½®ã€‚ |
| **recalibNeedStationaryFrames** | `6` | åµæ¸¬éœæ­¢æ‰€éœ€å½±æ ¼æ•¸ã€‚ |
| **recalibRequireConsecFrames** | `8` | ç¡¬æ ¡æ­£éœ€é€£çºŒé”æ¨™å½±æ ¼æ•¸ã€‚ |

---

##### ğŸ¦µ æŠ¬è…³ç¶­æŒéšæ®µ (HOLDING)
| åƒæ•¸ | é è¨­å€¼ | åŠŸèƒ½ |
|------|---------|------|
| **holdDropGraceSec** | `0.25f` | ç•¶ Î”è§’çŸ­æš«ä¸‹é™æ™‚ä»å…è¨±æŒçºŒè¨˜ç§’ï¼ˆæŠ—æŠ–å‹•å¯¬é™ï¼‰ã€‚ |
| **holdExitBelowFrames** | `2` | é€£çºŒå¹¾å¹€ä½æ–¼ idleThreshold å³çµæŸ HOLDINGã€‚ |
| **holdBandToleranceDeg** | `5f` | è¦–ç‚ºæˆåŠŸè§’åº¦å€é–“çš„é›™å‘å¯¬å®¹å€¼ã€‚ |
| **allowOvershootHold** | `true` | è‹¥è§’åº¦è¶…å‡º aMax ä½†æœªåš´é‡åç§»ä»ç¹¼çºŒè¨ˆæ™‚ã€‚ |

æ­¤éšæ®µä»¥ç©©å®šè§’åº¦ç‚ºä¸»ï¼Œå¼·èª¿åœ¨è¦–çª—å€é–“å…§é•·æ™‚é–“ç¶­æŒã€‚

---

##### ğŸ” å†·å»èˆ‡çµæŸéšæ®µ (COOLDOWN)
| åƒæ•¸ | é è¨­å€¼ | åŠŸèƒ½ |
|------|---------|------|
| **cooldownExitFrames** | `2` | é€£çºŒå¹€æ•¸ä½æ–¼ idleThreshold å³å› IDLEã€‚ |
| **cooldownMaxSec** | `1.0f` | è‹¥æŒçºŒé«˜è§’åº¦è¶…éæ­¤ç§’æ•¸å¼·åˆ¶çµæŸã€‚ |

---

##### ğŸ§® çµ±è¨ˆèˆ‡å›åˆåˆ¤æ–·
| åƒæ•¸ | é è¨­å€¼ | åŠŸèƒ½ |
|------|----------|------|
| **countSmallAsFail** | `true` | è‹¥ Î”è§’ä¸è¶³ (å°æ–¼ aMin) ä½†ä»ç¶­æŒè¶…é holdSecondsï¼Œæ˜¯å¦è¨˜å¤±æ•—ã€‚ |
| **toeLiftMaxRatio** | `0.06f` | è…³å°–é›¢åœ°æ¯”ä¾‹å®¹è¨±ä¸Šé™ï¼Œä¾æ“šè¶³é•·è¨ˆç®—ã€‚ |
| **fastRaiseOverrideSec** | `1.2f` | è‹¥ä¼‘æ¯ä¸è¶³ä½†å¿«é€Ÿé” aMin+2Â° ä¸¦æŒçºŒæ­¤ç§’æ•¸ï¼Œå³è¦–ç‚ºæœ‰æ•ˆèµ·èˆ‰ã€‚ |

---

é€™äº› CalfParams è¨­è¨ˆç”¨æ–¼ï¼š
- å¼·èª¿ã€Œå‹•ä½œç©©å®šã€èˆ‡ã€Œå¯¦éš›è¶³éƒ¨å¹¾ä½•ã€çš„æº–ç¢ºæ€§ï¼›
- è€ƒæ…®å…‰ç·šèˆ‡ç›¸æ©Ÿèª¤å·®ä¸‹ä¹‹è‡ªå‹•èª¿æ•´ï¼›
- åŒæ™‚æ”¯æŒå¾åˆæ¬¡æ ¡æ­£â†’å‹•ä½œç¶­æŒâ†’å†·å»çµæŸçš„å®Œæ•´ç‹€æ…‹æ©Ÿé‹ä½œã€‚

### 3ï¸âƒ£ å¾©å¥æè¸µï¼ˆRehabCalfDetectorï¼‰

#### åµæ¸¬æ¦‚è¿°
ç°¡åŒ–ç‰ˆ CalfDetectorï¼Œå°ˆæ³¨æ–¼æ¢å¾©æœŸä½¿ç”¨è€…ï¼ˆç·©é€Ÿç©©å®šã€å‹•æ…‹å¹³è¡¡é‡é»ï¼‰ã€‚

**é—œéµè§’åº¦ä¾†æºï¼š**
```kotlin
angle = âˆ (ankle, heel, foot_index)
```
å·¦å³è…³å¹³å‡è§’ï¼ˆDouble â†’ Floatï¼‰ã€‚

#### ç‹€æ…‹å¾ªç’°
| ç‹€æ…‹ | æ¢ä»¶ | èªªæ˜ |
|-------|-------|------|
| STAND | åˆå§‹ç‹€æ…‹ | æª¢æ¸¬è§’åº¦å¾…æå‡ |
| RAISING | angle â‰¥ raiseEnterDeg | æŠ¬å‡é‹å‹•éšæ®µ |
| HOLDING | angle â‰¥ holdMinDeg | ç©©å®šç¶­æŒç‹€æ…‹ï¼Œè¨ˆæ™‚ holdSec |
| LOWERING | è§’åº¦ä¸‹é™è‡³ idleThreshold | å›æ­¸åŸä½ |

#### æˆåŠŸæ¢ä»¶
- **æ¢ä»¶ä¸€**ï¼šholdSec â‰¥ `holdSeconds`
- **æ¢ä»¶äºŒ**ï¼šæ“ä½œéç¨‹è§’åº¦å¹³æ»‘ã€ä¸‹é™é€Ÿåº¦ä½æ–¼ `maxLowerSpeedDeg`
æˆåŠŸæ™‚ï¼š
```kotlin
commitSuccess(angle, holdSec)
```
è‹¥æå‰ä¸‹é™æˆ–é€Ÿåº¦éå¿«ï¼š
```kotlin
commitFail("EARLY_LOWER" or "UNSTABLE_RAISE")
```

#### ç‰¹é»
- åŠ å…¥é€Ÿåº¦æ§åˆ¶ (`dtheta`) ä»¥åˆ¤æ–·æŠ¬å‡ç©©å®šåº¦ã€‚  
- é©åˆç—…æ‚£ä½¿ç”¨ï¼Œåé‡ã€Œç©©å®šä¿æŒã€è€Œéé«˜åº¦ã€‚  
- æ¯å›åˆå‹•ä½œé¡¯ç¤ºæ–¼ `FrameHud` å«å¹³æ»‘è§’åº¦ã€fps èˆ‡é€Ÿåº¦ã€‚

---

### ğŸ¯ çµ±ä¸€çµ±è¨ˆè¼¸å‡º

æ‰€æœ‰ Detector é¡åˆ¥çš†æœƒï¼š
- å›å‚³ `FrameHud(angle, state, holdSec, success, fail)`
- å…§å«è©³ç´°çµ±è¨ˆæ¬„ä½ï¼ˆExtra Mapï¼‰ï¼š
  - ç•¶å‰è§’åº¦ã€Î”è§’æˆ–åŸºæº–è§’
  - FPS
  - å‹•ä½œå´ã€ç‹€æ…‹æ¨™ç±¤ã€æŒçºŒç§’æ•¸

å®Œæˆå¾Œç”± Session ç®¡ç†å±¤ï¼ˆ`DetectionActivity`ï¼‰é€éï¼š
```kotlin
viewModel.getCounts()
```
åŒ¯ç¸½å‡ºæˆåŠŸ / å¤±æ•— / ç¸½æ•¸ï¼Œä¸¦ä»¥ `SessionResultWriter` è‡ªå‹•å„²å­˜ã€‚

---

## ğŸ§˜â€â™‚ï¸ å¾©å¥æè¸µ (RehabCalfParams) â€” åƒæ•¸èˆ‡ç”¨é€”è©³è§£

è©²çµ„åƒæ•¸é©ç”¨æ–¼ç—…æ‚£çš„ç·©é€ŸæŸ”å’Œå¾©å¥æµç¨‹ï¼Œé‡é»åœ¨ç©©å®šä¿æŒèˆ‡ä¸‹é™æ§åˆ¶ï¼Œè€Œéé«˜åº¦ã€‚

| åƒæ•¸åç¨± | é è¨­å€¼ | èªªæ˜ |
|------------|----------|-----------|
| **emaAlpha** | `0.35f` | å¹³æ»‘è§’åº¦è®ŠåŒ–ï¼ŒæŠ‘åˆ¶å½±åƒæŠ–å‹•ç”¢ç”Ÿçš„è§’åº¦å°–å³°ã€‚ |
| **holdSeconds** | `3.0f` | æŠ¬è…³éœ€ç¶­æŒåœ¨æœ‰æ•ˆå€é–“å…§çš„ç§’æ•¸ä»¥è¨ˆå…¥æˆåŠŸã€‚ |
| **raiseEnterDeg** | `3f` | é€²å…¥ã€ŒæŠ¬å‡ç‹€æ…‹ã€(RAISING) çš„æœ€ä½ä»°è§’é–€æª»ã€‚ |
| **holdMinDeg** | `5f` | é€²å…¥ã€Œä¿æŒéšæ®µã€(HOLDING) çš„æœ€å°ä»°è§’ã€‚ |
| **lowerExitDeg** | `6f` | è‹¥è§’åº¦é™è‡³æ­¤å€¼ä»¥ä¸‹ï¼Œè¦–ç‚ºæå‰çµæŸï¼Œå› STAND ç‹€æ…‹ä¸¦å¯èƒ½è¨˜ç‚º FAILã€‚ |
| **idleThreshold** | `3f` | å®šç¾©éœæ­¢å€ï¼Œå°æ–¼æ­¤è§’åº¦ä»£è¡¨ç«™ç©©æˆ–æœªå‹•ä½œã€‚ |
| **maxLowerSpeedDeg** | `40f` | æœ€å¤§å…è¨±ä¸‹é™é€Ÿåº¦ï¼ˆåº¦/ç§’ï¼‰ï¼Œè‹¥è¶…å‡ºå‰‡åˆ¤ç‚ºå‹•ä½œä¸ç©©æˆ–æ‰è½ã€‚ |

#### å‹•ä½œæµç¨‹ç‹€æ…‹æ©Ÿ
| ç‹€æ…‹ | é€²å…¥æ¢ä»¶ | å‹•ä½œæè¿° |
|-------|-----------|-----------|
| **STAND** | èµ·å§‹è§’ â‰¤ idleThreshold | ç­‰å¾…æè¸µé–‹å§‹ã€‚ |
| **RAISING** | è§’åº¦ â‰¥ raiseEnterDeg | æŠ¬è…³éç¨‹æŒçºŒä¸Šå‡ã€‚ |
| **HOLDING** | è§’åº¦ â‰¥ holdMinDeg ä¸”æ™‚é–“ç´¯ç© â‰¥ holdSeconds | ç¶­æŒè…³å°–æŠ¬é«˜ç‹€æ…‹ã€‚ |
| **LOWERING** | è§’åº¦ä¸‹é™æˆ–ææ—©æ”¾ä¸‹ | å›å¾©ç«™ç«‹æˆ–ç´€éŒ„ FAILã€‚ |

#### ä½¿ç”¨å»ºè­°
- `raiseEnterDeg` æ§åˆ¶å•Ÿå‹•éˆæ•åº¦ï¼Œé©åˆä¸åŒé‹å‹•å¹…åº¦æ‚£è€…ï¼›
- `holdSeconds` å¯è¦–è‚Œè€åŠ›å¼·åº¦èª¿æ•´ï¼›
- `maxLowerSpeedDeg` æä¾›å°ç—…æ‚£ç©©å®šæ§åˆ¶åŠ›çš„ç›£æ¸¬æŒ‡æ¨™ã€‚

é€™äº› RehabCalfParams å¯ç”¨æ–¼è‡¨åºŠè‡ªå‹•è©•ä¼°è…³è¸ç©©å®šåº¦ï¼Œä»¥åŠåº·å¾©éç¨‹ä¸­çš„å¹³è¡¡èˆ‡æ§åˆ¶åŠ›è¨“ç·´ã€‚


---


## ğŸ§± æŠ€è¡“æ¶æ§‹

ä¸»æµç¨‹ï¼š
```
CameraX â–¶ PoseLandmarkerClient â–¶ Detector â–¶ HUD/Overlay â–¶ ViewModel â–¶ UI
```

### æ¨¡çµ„åˆ†å±¤
- **MediaPipe å±¤**  
  è² è²¬å½±åƒè½‰æ›ã€å§¿å‹¢æ¨è«–ã€‚
- **Domain å±¤**  
  åˆ¤æ–·å§¿å‹¢æˆåŠŸ/å¤±æ•—ã€è¨ˆæ•¸ã€è§’åº¦ã€‚
- **Overlay å±¤**  
  å„²å­˜ç¹ªè£½ç‹€æ…‹ä¸¦æ–¼ Canvas å³æ™‚å‘ˆç¾ã€‚
- **UI å±¤**  
  æä¾›äº’å‹•ã€åƒæ•¸è¨­å®šåŠçµæœå„²å­˜ã€‚

---

## ğŸ“ ä¸»è¦å…ƒä»¶

| æ¨¡çµ„ | åŠŸèƒ½ | ç¯„ä¾‹æª”æ¡ˆ |
|-------|-------|-----------|
| `app/ui` | ä¸»ç•«é¢èˆ‡åµæ¸¬æµç¨‹æ§åˆ¶ | [`MainActivity.kt`](mediapipe-samples/examples/pose_landmarker/android/app/src/main/java/app/ui/MainActivity.kt:15) |
| `app/data` | è³‡æ–™è¼¸å‡ºèˆ‡å„²å­˜ | [`SessionResultWriter.kt`](mediapipe-samples/examples/pose_landmarker/android/app/src/main/java/app/data/SessionResultWriter.kt) |
| `rehabcore/domain` | å‹•ä½œé‚è¼¯èˆ‡ç‹€æ…‹ç›£æ¸¬ | [`Detector.kt`](mediapipe-samples/examples/pose_landmarker/android/app/src/main/java/rehabcore/domain/Detector.kt:5) |
| `rehabcore/mediapipe` | å§¿å‹¢æ¨è«–å°è£ | [`PoseLandmarkerClient.kt`](mediapipe-samples/examples/pose_landmarker/android/app/src/main/java/rehabcore/mediapipe/PoseLandmarkerClient.kt:23) |
| `rehabcore/overlay` | HUDã€éª¨æ¶ç¹ªè£½ | [`SkeletonOverlay.kt`](mediapipe-samples/examples/pose_landmarker/android/app/src/main/java/rehabcore/overlay/SkeletonOverlay.kt:11) |

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1ï¸âƒ£ éœ€æ±‚
- Android Studio Arctic Fox+
- API â‰¥ 24  
- Gradle â‰¥ 7  
- Kotlin â‰¥ 1.7  
- MediaPipe Tasks Vision

### 2ï¸âƒ£ å»ºç½®æ­¥é©Ÿ
```bash
# åŒ¯å…¥å°ˆæ¡ˆ
open mediapipe-samples/examples/pose_landmarker/android/
# åŸ·è¡Œ
Run -> MainActivity
```

åµæ¸¬å¾Œæœƒè‡ªå‹•ç”Ÿæˆçµæœæª”ï¼š
```
/data/data/<package>/files/sessions/YYYYMMDD_HHmm_<ACTION>.json
```

---

## ğŸ”— æ•´åˆæŒ‡å—

### èˆ‡ä¸»ç³»çµ±æ•´åˆ
å¯ä½œç‚ºç¨ç«‹æ¨¡çµ„å°å…¥ï¼š
```gradle
include(":pose_module")
project(":pose_module").projectDir = file("mediapipe-samples/examples/pose_landmarker/android/app")
```

æˆ–ç›´æ¥å•Ÿå‹•ï¼š
```kotlin
startActivity(
  Intent(this, DetectionActivity::class.java)
    .putExtra(DetectionActivity.EXTRA_ACTION, "CALF")
)
```

### çµæœå›å‚³èˆ‡ä¸Šå‚³
æ•´åˆå¾Œå¯ç”±ä¸»ç³»çµ±ç›£è½ï¼š
```kotlin
override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
    if (resultCode == RESULT_OK) { uploadSessionJson() }
}
```

---

## ğŸ§© é€²éšé–‹ç™¼èˆ‡é™¤éŒ¯æŠ€å·§

- **FPSä½è½** â†’ æ”¹ç”¨ `pose_landmarker_lite.task`  
- **é¡åƒç•°å¸¸** â†’ èª¿æ•´ `mirror` flag  
- **éª¨æ¶é–ƒçˆ** â†’ åœ¨ `invalidate()` åœ°æ–¹ç¯€æµé‡ç¹ª  
- **æ–°å¢å‹•ä½œ** â†’ å¯¦ä½œæ–° Detector ä¸¦è£œå……è‡³ `ActionType`

### æœªä¾†æ–¹å‘
- AI è‡ªå‹•ç³¾æ­£å§¿å‹¢  
- å¾©å¥é€²åº¦é›²ç«¯çµ±è¨ˆ  
- è·¨å¹³å°ç¨‹å¼åº«å°è£  
- Node/Flutter æ•´åˆç‰ˆæœ¬

---

ğŸ‘¤ **ç¶­è­·è²¬ä»»äºº**ï¼šMackay Rehab R&D  
ğŸ“… æ–‡ä»¶æ›´æ–°æ—¥æœŸï¼š2025/10/27